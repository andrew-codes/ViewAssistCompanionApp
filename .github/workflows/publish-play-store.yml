name: Publish to Google Play Store

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    # Only run if the release tag matches v*.*.* pattern
    if: startsWith(github.event.release.tag_name, 'v')
    steps:
      - name: Get release tag
        id: get_tag
        run: |
          TAG_NAME=${{ github.event.release.tag_name }}
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG_NAME"

      - name: Download AAB from GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download ${{ steps.get_tag.outputs.tag }} \
            --repo ${{ github.repository }} \
            --pattern "*.aab" \
            --dir ./release_files

      - name: Publish to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: codes.andrew.vacompanion
          releaseFiles: release_files/*.aab
          track: internal
          releaseName: ${{ steps.get_tag.outputs.tag }}
          status: completed
          inAppUpdatePriority: 2
